name: Profile Dashboard Update

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

jobs:
  update-profile:
    name: Update GitHub Profile Dashboard
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GH_ACTOR: ${{ vars.GH_ACTOR }}
      GH_EMAIL: ${{ vars.GH_EMAIL }}
      GH_USERNAME: ${{ vars.GH_USERNAME }}
      GH_REPO: ${{ vars.GH_REPO }}
    steps:
      - name: Validate Required Secrets
        run: |
          missing_secrets=()

          if [ -z "${{ secrets.WAKATIME_API_KEY }}" ]; then
            missing_secrets+=("WAKATIME_API_KEY")
          fi

          if [ -z "${{ secrets.GITHUB_TOKEN }}" ]; then
            missing_secrets+=("GITHUB_TOKEN")
          fi

          if [ -z "${{ secrets.GH_TOKEN }}" ]; then
            missing_secrets+=("GH_TOKEN")
          fi

          if [ -z "${{ env.GH_EMAIL }}" ]; then
            missing_secrets+=("GH_EMAIL")
          fi

          if [ -z "${{ env.GH_USERNAME }}" ]; then
            missing_secrets+=("GH_USERNAME")
          fi

          if [ -z "${{ env.GH_ACTOR }}" ]; then
            missing_secrets+=("GH_ACTOR")
          fi

          if [ -z "${{ env.GH_REPO }}" ]; then
            missing_secrets+=("GH_REPO")
          fi

          if [ ${#missing_secrets[@]} -ne 0 ]; then
            echo "Error: The following required secrets are missing: ${missing_secrets[*]}"
            echo "Please define them in the repository settings."
            exit 1
          fi

          echo "All required secrets are defined."

      - name: Setup Git Configuration
        run: |
          git config --global user.name "${{ env.GH_ACTOR }}"
          git config --global user.email "${{ env.GH_EMAIL }}"
          git config --global init.defaultBranch main

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 5
          repository: ${{ env.GH_REPO }}
          ref: main
          clean: false
          submodules: false
          show-progress: false

      - name: Setup Cache for WakaTime
        uses: actions/cache@v4
        id: cache
        continue-on-error: true
        timeout-minutes: 10
        with:
          path: .cache
          key: wakatime-cache-${{ vars.GH_REPO }}-${{ github.run_number }}-${{ hashFiles('.github/workflows/update-profile.yml') }}
          restore-keys: |
            wakatime-cache-${{ vars.GH_REPO }}-
            wakatime-cache-

      - name: Handle Cache Status
        id: cache-status
        run: |
          if [ -d ".cache" ]; then
            echo "Cache hit, restoring..."
            echo "cache_hit=true" >> $GITHUB_OUTPUT
          else
            echo "No cache found, creating a new one."
            mkdir -p .cache
            echo "cache_hit=false" >> $GITHUB_OUTPUT
          fi

      - name: Update README with WakaTime Stats
        uses: athul/waka-readme@master
        timeout-minutes: 10
        continue-on-error: true
        id: wakatime-stats-update-readme
        with:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
          REPOSITORY: ${{ env.GH_REPO }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          AUTHOR_EMAIL: ${{ env.GH_EMAIL }}
          AUTHOR_NAME: ${{ env.GH_ACTOR }}
          COMMITTER_EMAIL: ${{ vars.GH_EMAIL }}
          COMMITTER_NAME: ${{ vars.GH_ACTOR }}
          COMMIT_MESSAGE: "chore(stats): update README.md with WakaTime Readme [skip ci]"
          TARGET_BRANCH: main
          SHOW_TITLE: true
          CODE_LANG: py js java go ruby php ts html css sh kt rust json yaml yml md
          TIME_RANGE: all_time
          LANG_COUNT: 15
          SECTION_NAME: "wakareadme"

      - name: Update WakaTime Stats
        uses: anmol098/waka-readme-stats@master
        with:
          WAKATIME_API_KEY: ${{ secrets.WAKATIME_API_KEY }}
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
          SECTION_NAME: "waka"
          SHOW_LINES_OF_CODE: "True"
          SHOW_PROFILE_VIEWS: "True"
          SHOW_COMMIT: "True"
          SHOW_DAYS_OF_WEEK: "True"
          SHOW_LANGUAGE: "True"
          SHOW_OS: "True"
          SHOW_PROJECTS: "True"
          SHOW_EDITORS: "True"
          SHOW_LANGUAGE_PER_REPO: "True"
          SHOW_SHORT_INFO: "True"
          SHOW_LOC_CHART: "True"
          SHOW_UPDATED_DATE: "True"
          SHOW_TOTAL_CODE_TIME: "True"
          SHOW_TIMEZONE: "True"
          COMMIT_MESSAGE: "chore(stats): update wakatime stats [skip ci]"
          COMMIT_SINGLE: "False"
          DEBUG_LOGGING: "True"
          COMMIT_BY_ME: "True"
          IGNORED_REPOS: '["${{ vars.GH_REPO }}"]'
          PULL_BRANCH_NAME: "main"
          PUSH_BRANCH_NAME: "main"
          UPDATED_DATE_FORMAT: "YYYY-MM-DD"
          COMMIT_USERNAME: "${{ vars.GH_ACTOR }}"
          COMMIT_EMAIL: "${{ vars.GH_EMAIL }}"
